# 核心数据结构说明

## 📋 概述

本系统采用**统一的数据模型**来管理三种类型的内容：
- **Idea（创意）**：创新想法和建议
- **Gossiping（吐槽）**：员工声音和反馈
- **Voice（心声）**：统称，通过 `type` 字段区分上述两种类型

所有内容都存储在 `voice` 表中，通过 `type` 字段进行区分。

---

## 🗂️ 核心数据表结构

### 1. voice 表（心声/帖子表）

**表说明**：统一存储创意（Idea）和吐槽（Gossiping）的核心数据。

#### 数据库表结构

```sql
CREATE TABLE voice (
    id INTEGER PRIMARY KEY AUTOINCREMENT,        -- 主键ID
    user_id INTEGER NOT NULL,                    -- 发布者用户ID（外键→USER.id）
    title TEXT,                                   -- 标题
    content TEXT,                                 -- 内容（最大5000字符）
    commented INTEGER DEFAULT 0,                  -- 评论数统计
    voted INTEGER DEFAULT 0,                      -- 点赞数统计
    recommended INTEGER DEFAULT 0,                -- 推荐数（用于创新想法）
    agreed INTEGER DEFAULT 0,                     -- 赞同数（用于吐槽）
    disagreed INTEGER DEFAULT 0,                  -- 不赞同数（用于吐槽）
    type TEXT,                                    -- 类型：'IDEA'（创意）或 'GOSSIPING'（吐槽）
    status TEXT,                                  -- 状态：'NORMAL'（正常）或 'TO_PROJECT'（已转为项目）
    images TEXT,                                  -- 图片列表（JSON格式字符串）
    is_deleted INTEGER DEFAULT 0,                 -- 是否删除（软删除：0=未删除，1=已删除）
    create_time DATETIME,                         -- 创建时间
    update_time DATETIME                          -- 更新时间
);
```

#### Java 实体类（Entity）

```java
public class Voice implements Serializable {
    private Long id;                              // 主键ID
    private Long userId;                          // 发布者用户ID
    private String title;                         // 标题
    private String content;                      // 内容
    private Integer commented;                   // 评论数
    private Integer voted;                        // 点赞数
    private Integer recommended;                  // 推荐数（用于创新想法）
    private Integer agreed;                       // 赞同数（用于吐槽）
    private Integer disagreed;                    // 不赞同数（用于吐槽）
    private String type;                          // 类型：IDEA 或 GOSSIPING
    private String status;                         // 状态：NORMAL 或 TO_PROJECT
    private String images;                         // 图片列表（JSON格式）
    private Boolean isDeleted;                     // 是否删除
    private Timestamp createTime;                  // 创建时间
    private Timestamp updateTime;                  // 更新时间
}
```

#### Java DTO（数据传输对象）

```java
public class VoiceDTO implements Serializable {
    private Long id;
    private Long userId;
    private UserDTO user;                          // 发布者用户信息（关联查询）
    
    private List<Long> atUserIds;                  // @的用户ID列表
    private List<UserDTO> atUsers;                // @的用户信息列表
    
    private String title;
    private String content;
    private Integer commented;                    // 评论数
    private Integer voted;                         // 点赞数
    private Integer recommended;                  // 推荐数（用于创新想法）
    private Integer agreed;                        // 赞同数（用于吐槽）
    private Integer disagreed;                     // 不赞同数（用于吐槽）
    private VoiceType type;                        // 类型枚举：IDEA 或 GOSSIPING
    private VoiceStatus status;                    // 状态枚举：NORMAL 或 TO_PROJECT
    
    private List<String> images;                   // 图片URL列表
    private List<Integer> tags;                   // 标签ID列表
    private List<Long> voteUserIds;                // 点赞用户ID列表
    private Timestamp createTime;
    private Timestamp updateTime;
}
```

---

## 📊 类型枚举

### VoiceType（心声类型）

```java
public enum VoiceType {
    IDEA,        // 创意：创新想法和建议
    GOSSIPING    // 吐槽：员工声音和反馈
}
```

**业务规则**：
- `IDEA`：用于创新想法，支持"推荐"功能
- `GOSSIPING`：用于员工吐槽，支持"赞同/不赞同"功能，用户信息匿名显示

### VoiceStatus（心声状态）

```java
public enum VoiceStatus {
    NORMAL,      // 正常状态：已发布
    TO_PROJECT   // 已转为项目：创意被采纳并转为项目
}
```

**业务规则**：
- `NORMAL`：正常发布状态，用户可以查看和互动
- `TO_PROJECT`：创意已被采纳，转为项目，通常显示在"已转为项目"列表中

---

## 🔗 关联表结构

### 2. voice_recommend 表（推荐表）

**用途**：记录用户对创意（IDEA）的推荐操作。

```sql
CREATE TABLE voice_recommend (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,                     -- 推荐用户ID
    voice_id INTEGER NOT NULL,                    -- 被推荐的心声ID
    create_time DATETIME,
    update_time DATETIME,
    UNIQUE(user_id, voice_id)                     -- 唯一约束：同一用户对同一心声只能推荐一次
);
```

**业务规则**：
- 仅用于 `type = 'IDEA'` 的心声
- 用户推荐后，`voice.recommended` 字段自动 +1
- 取消推荐后，`voice.recommended` 字段自动 -1
- 通过唯一约束防止重复推荐

### 3. voice_agree 表（赞同/不赞同表）

**用途**：记录用户对吐槽（GOSSIPING）的赞同/不赞同操作。

```sql
CREATE TABLE voice_agree (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,                     -- 操作用户ID
    voice_id INTEGER NOT NULL,                    -- 被操作的心声ID
    agree_type INTEGER NOT NULL DEFAULT 1,        -- 类型：1=赞同，0=不赞同
    create_time DATETIME,
    update_time DATETIME,
    UNIQUE(user_id, voice_id)                     -- 唯一约束：同一用户对同一心声只能操作一次
);
```

**业务规则**：
- 仅用于 `type = 'GOSSIPING'` 的心声
- `agree_type = 1`：赞同，`voice.agreed` 字段自动 +1
- `agree_type = 0`：不赞同，`voice.disagreed` 字段自动 +1
- 用户修改操作（从赞同改为不赞同，或反之）时，相应字段会调整
- 通过唯一约束防止重复操作

### 4. voice_tag 表（心声标签关联表）

**用途**：实现心声与标签的多对多关系。

```sql
CREATE TABLE voice_tag (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    voice_id INTEGER,                            -- 心声ID
    tag_id INTEGER,                               -- 标签ID
    create_time DATETIME,
    update_time DATETIME
);
```

**业务规则**：
- 一个心声可以有多个标签
- 一个标签可以关联多个心声
- 用于分类和筛选

### 5. voice_at 表（@提醒表）

**用途**：记录发布心声时@的用户提醒。

```sql
CREATE TABLE voice_at (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    voice_id INTEGER,                            -- 心声ID
    user_id INTEGER,                              -- 被@的用户ID
    is_read INTEGER DEFAULT 0,                    -- 是否已读：0=未读，1=已读
    create_time DATETIME,
    update_time DATETIME
);
```

**业务规则**：
- 发布心声时可以@多个用户
- `is_read = 0` 表示未读，用于消息中心显示
- 用户查看后更新 `is_read = 1`

---

## 📈 统计字段说明

### voice 表的统计字段

| 字段名 | 类型 | 说明 | 适用类型 |
|--------|------|------|---------|
| `commented` | INTEGER | 评论数 | IDEA、GOSSIPING |
| `voted` | INTEGER | 点赞数 | IDEA、GOSSIPING |
| `recommended` | INTEGER | 推荐数 | **仅 IDEA** |
| `agreed` | INTEGER | 赞同数 | **仅 GOSSIPING** |
| `disagreed` | INTEGER | 不赞同数 | **仅 GOSSIPING** |

**设计目的**：
- 减少关联查询，提高性能
- 实时统计，避免每次查询时计算
- 通过触发器或应用层逻辑维护数据一致性

---

## 🎯 业务逻辑差异

### Idea（创意）的业务逻辑

1. **推荐功能**：
   - 用户可以"推荐"创意
   - 推荐记录存储在 `voice_recommend` 表
   - `voice.recommended` 字段统计推荐数

2. **状态流转**：
   - 初始状态：`NORMAL`
   - 可转为项目：`TO_PROJECT`
   - 转为项目后，创意会被标记为已采纳

3. **用户信息**：
   - 显示真实用户名和头像
   - 支持@用户提醒

### Gossiping（吐槽）的业务逻辑

1. **赞同/不赞同功能**：
   - 用户可以"赞同"或"不赞同"吐槽
   - 操作记录存储在 `voice_agree` 表
   - `voice.agreed` 和 `voice.disagreed` 字段分别统计

2. **匿名机制**：
   - 用户信息匿名显示（使用昵称生成器）
   - 保护用户隐私，鼓励真实反馈

3. **状态**：
   - 通常保持 `NORMAL` 状态
   - 不转为项目

---

## 🔄 数据流转关系图

```
USER (用户)
  │
  ├── 1:N → voice (创建的心声)
  │       │
  │       ├── type = 'IDEA' (创意)
  │       │   ├── 1:N → voice_recommend (推荐记录)
  │       │   ├── 1:N → COMMENT (评论)
  │       │   ├── 1:N → vote (点赞)
  │       │   ├── 1:N → voice_at (@提醒)
  │       │   └── N:M → tag (通过voice_tag关联)
  │       │
  │       └── type = 'GOSSIPING' (吐槽)
  │           ├── 1:N → voice_agree (赞同/不赞同记录)
  │           ├── 1:N → COMMENT (评论)
  │           ├── 1:N → vote (点赞)
  │           ├── 1:N → voice_at (@提醒)
  │           └── N:M → tag (通过voice_tag关联)
  │
  ├── 1:N → COMMENT (发表的评论)
  ├── 1:N → vote (点赞记录)
  ├── 1:N → voice_recommend (推荐记录，仅IDEA)
  ├── 1:N → voice_agree (赞同/不赞同记录，仅GOSSIPING)
  └── 1:N → voice_at (被@的记录)
```

---

## 📝 数据示例

### Idea（创意）示例

```json
{
  "id": 1,
  "userId": 100,
  "user": {
    "id": 100,
    "userName": "张三",
    "fullName": "张三",
    "avatar": "https://example.com/avatar.jpg"
  },
  "title": "关于优化工作流程的建议",
  "content": "建议优化当前的工作流程，提高效率...",
  "type": "IDEA",
  "status": "NORMAL",
  "commented": 5,
  "voted": 10,
  "recommended": 3,
  "agreed": 0,
  "disagreed": 0,
  "images": ["https://example.com/img1.jpg"],
  "tags": [1, 2],
  "createTime": "2025-01-01 10:00:00",
  "updateTime": "2025-01-01 10:00:00"
}
```

### Gossiping（吐槽）示例

```json
{
  "id": 2,
  "userId": 200,
  "user": {
    "id": 200,
    "userName": "用户001",  // 匿名显示
    "fullName": "用户001",  // 匿名显示
    "avatar": "https://example.com/default.jpg"
  },
  "title": "关于食堂饭菜的建议",
  "content": "希望食堂能提供更多种类的菜品...",
  "type": "GOSSIPING",
  "status": "NORMAL",
  "commented": 8,
  "voted": 15,
  "recommended": 0,
  "agreed": 12,
  "disagreed": 2,
  "images": [],
  "tags": [3],
  "createTime": "2025-01-01 11:00:00",
  "updateTime": "2025-01-01 11:00:00"
}
```

---

## 🔍 查询场景

### 1. 查询创意列表（IDEA）

```sql
SELECT * FROM voice 
WHERE type = 'IDEA' 
  AND is_deleted = 0 
  AND status = 'NORMAL'
ORDER BY recommended DESC, create_time DESC;
```

### 2. 查询吐槽列表（GOSSIPING）

```sql
SELECT * FROM voice 
WHERE type = 'GOSSIPING' 
  AND is_deleted = 0 
  AND status = 'NORMAL'
ORDER BY agreed DESC, create_time DESC;
```

### 3. 查询已转为项目的创意

```sql
SELECT * FROM voice 
WHERE type = 'IDEA' 
  AND is_deleted = 0 
  AND status = 'TO_PROJECT'
ORDER BY update_time DESC;
```

---

## 📌 关键设计点

### 1. 统一数据模型
- 所有内容类型使用同一张表，简化数据管理
- 通过 `type` 字段区分业务逻辑
- 减少表结构复杂度

### 2. 统计字段优化
- 使用冗余字段存储统计数据
- 避免频繁的 COUNT 查询
- 提高查询性能

### 3. 软删除机制
- 使用 `is_deleted` 字段标记删除
- 保留历史数据，支持数据恢复
- 查询时自动过滤已删除数据

### 4. 类型特定的功能表
- `voice_recommend`：仅用于 IDEA
- `voice_agree`：仅用于 GOSSIPING
- 通过应用层逻辑保证数据一致性

### 5. 匿名机制
- GOSSIPING 类型使用昵称生成器
- 保护用户隐私
- 鼓励真实反馈

---

## 📚 相关文件位置

### 实体类
- `voice_community_backend/src/main/java/com/vc/pojo/entity/Voice.java`
- `voice_community_backend/src/main/java/com/vc/pojo/entity/VoiceType.java`
- `voice_community_backend/src/main/java/com/vc/pojo/entity/VoiceStatus.java`
- `voice_community_backend/src/main/java/com/vc/pojo/entity/VoiceRecommend.java`
- `voice_community_backend/src/main/java/com/vc/pojo/entity/VoiceAgree.java`

### DTO 类
- `voice_community_backend/src/main/java/com/vc/pojo/dto/VoiceDTO.java`

### 数据库迁移文件
- `voice_community_backend/src/main/resources/db/migration/V20241206__add_initial_table.sql`
- `voice_community_backend/src/main/resources/db/migration/V20250125__add_recommend_and_agree_tables.sql`
- `voice_community_backend/src/main/resources/db/migration/V20241215__alter_voice_and_add_voice_tags_table.sql`

---

**文档版本**：v1.0  
**最后更新**：2025-12-30

