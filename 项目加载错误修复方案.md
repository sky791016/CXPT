# 项目加载错误修复方案

## 📋 问题分析

### 1. SQL 语法错误（已修复）

**错误信息**：
```
[SQLITE_ERROR] SQL error or missing database (near ".": syntax error)
```

**原因**：
- `CommentMapper.xml` 中使用了中文标点符号（中文括号 `（` `）` 和中文逗号 `，`）
- SQLite 无法识别中文标点符号，导致 SQL 语法错误

**修复状态**：✅ 已修复
- 已将中文括号 `（` `）` 改为英文括号 `(` `)`
- 已将中文逗号 `，` 改为英文逗号 `,`
- 优化了 SQL 查询的排序逻辑

**需要操作**：重启后端服务以加载修复后的 XML 文件

### 2. Java 编译错误

**错误信息**：
```
java.lang.NoSuchFieldException: com.sun.tools.javac.code.TypeTag :: UNKNOWN
Caused by: lombok.javac.Javac.<clinit>(Javac.java:187)
```

**原因**：
- 系统使用 Java 25
- Lombok 1.18.36 不支持 Java 25
- Maven 编译器插件与 Java 25 存在兼容性问题

**影响**：
- 无法通过 Maven 编译项目
- 但可以通过 IDE（如 IntelliJ IDEA）直接运行

**解决方案**：见下方

## 🔧 修复步骤

### 步骤 1：重启后端服务（加载修复后的 SQL）

由于 MyBatis 的 XML 文件不需要重新编译，只需要重启服务即可加载修复后的文件。

#### 方法 A：使用运行中的 JAR 文件（推荐）

```bash
# 1. 停止当前运行的后端服务
cd "/Users/super_kai/Programing/CXPT 2"
ps aux | grep "voice_community_backend.*jar" | grep -v grep | awk '{print $2}' | xargs kill -15

# 2. 等待几秒确保服务停止
sleep 3

# 3. 重新启动后端服务（主后端）
cd voice_community_backend
nohup java -jar target/voice_community_backend-0.0.1-SNAPSHOT.jar > logs/app.log 2>&1 &

# 4. 重新启动管理后端
cd ../voice_community_admin_backend
nohup java -jar target/voice_community_admin_backend-0.0.1-SNAPSHOT.jar > logs/app.log 2>&1 &

# 5. 检查服务是否启动成功
sleep 5
ps aux | grep "voice_community.*jar" | grep -v grep
```

#### 方法 B：使用 Maven 直接运行（如果编译成功）

```bash
# 主后端
cd voice_community_backend
mvn spring-boot:run > logs/app.log 2>&1 &

# 管理后端
cd voice_community_admin_backend
mvn spring-boot:run > logs/app.log 2>&1 &
```

### 步骤 2：解决 Java 编译问题（可选）

如果需要重新编译项目，有以下方案：

#### 方案 A：使用 Java 21（推荐）

```bash
# 1. 检查已安装的 Java 版本
/usr/libexec/java_home -V

# 2. 设置 JAVA_HOME 为 Java 21
export JAVA_HOME=$(/usr/libexec/java_home -v 21)

# 3. 验证 Java 版本
java -version

# 4. 重新编译
cd voice_community_backend
mvn clean package -DskipTests

cd ../voice_community_admin_backend
mvn clean package -DskipTests
```

#### 方案 B：使用 IDE 编译和运行（推荐用于开发）

1. 使用 IntelliJ IDEA 或 Eclipse
2. 确保 IDE 使用 Java 21
3. 在 IDE 中直接运行 `VoiceCommunityBackendApplication`
4. IDE 通常能更好地处理 Lombok 注解

#### 方案 C：等待 Lombok 更新

等待 Lombok 发布支持 Java 25 的版本，然后更新依赖。

## ✅ 验证修复

### 1. 检查服务状态

```bash
# 检查后端服务是否运行
ps aux | grep "voice_community.*jar" | grep -v grep

# 检查端口是否监听
lsof -i :8081  # 主后端
lsof -i :8082  # 管理后端
```

### 2. 测试评论 API

```bash
# 测试获取评论列表
curl "http://localhost:8081/api/comment/getAllCommentByVoiceId?pageNum=1&pageSize=10&voiceId=65&orderBy=update_time"

# 应该返回 JSON 数据，而不是 500 错误
```

### 3. 查看日志

```bash
# 查看主后端日志
tail -f voice_community_backend/logs/app.log

# 查看管理后端日志
tail -f voice_community_admin_backend/logs/app.log

# 检查是否有 SQL 错误
grep -i "sql error" voice_community_backend/logs/app.log
```

## 📊 当前服务状态

根据进程检查，以下服务正在运行：

- ✅ **主后端服务** (端口 8081) - 进程 ID: 98738
- ✅ **管理后端服务** (端口 8082) - 进程 ID: 98803
- ✅ **Web 门户前端** (端口 2002) - Vite 开发服务器
- ✅ **移动端前端** (端口 2000) - 可能在其他终端运行
- ✅ **管理后台前端** (端口 2001) - 可能在其他终端运行

## 🎯 快速修复命令

一键重启后端服务（加载修复后的 SQL）：

```bash
cd "/Users/super_kai/Programing/CXPT 2"

# 停止服务
ps aux | grep "voice_community.*jar" | grep -v grep | awk '{print $2}' | xargs kill -15
sleep 3

# 启动主后端
cd voice_community_backend
nohup java -jar target/voice_community_backend-0.0.1-SNAPSHOT.jar > logs/app.log 2>&1 &

# 启动管理后端
cd ../voice_community_admin_backend
nohup java -jar target/voice_community_admin_backend-0.0.1-SNAPSHOT.jar > logs/app.log 2>&1 &

# 等待启动
sleep 5

# 验证
echo "✅ 服务状态："
ps aux | grep "voice_community.*jar" | grep -v grep
echo ""
echo "✅ 端口监听："
lsof -i :8081 -i :8082 | grep LISTEN
```

## 📝 注意事项

1. **XML 文件不需要重新编译**：MyBatis 的 XML 映射文件在运行时动态加载，重启服务即可生效。

2. **Java 版本问题**：如果使用 Java 25，建议切换到 Java 21 或使用 IDE 运行。

3. **日志文件位置**：
   - 主后端：`voice_community_backend/logs/app.log`
   - 管理后端：`voice_community_admin_backend/logs/app.log`

4. **数据库文件**：确保数据库文件存在且可访问
   - 主后端：`voice_community_backend/data/voice_community.db`
   - 管理后端：使用主后端的数据库文件

## 🔍 常见问题

### Q: 重启后仍然报 SQL 错误？

A: 检查以下几点：
1. 确认 `CommentMapper.xml` 文件已保存
2. 确认服务已完全重启（检查进程 ID 是否变化）
3. 查看日志确认加载的是新文件
4. 清除浏览器缓存（如果是前端问题）

### Q: 如何确认修复已生效？

A: 执行以下测试：
```bash
# 测试评论 API
curl "http://localhost:8081/api/comment/getAllCommentByVoiceId?pageNum=1&pageSize=10&voiceId=65&orderBy=update_time"

# 如果返回 JSON 数据而不是错误，说明修复成功
```

### Q: 编译失败但服务能运行？

A: 这是正常的。如果使用 IDE 运行或已有编译好的 JAR 文件，服务可以正常运行。编译失败只影响重新打包。

