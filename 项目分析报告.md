# 语音社区系统 - 代码结构与数据库设计分析

## 一、项目概述

这是一个**语音社区/创新广场系统**，包含前端（React）和后端（Spring Boot）两个模块，主要用于企业内部员工发布创意想法、交流讨论、点赞评论等功能。

---

## 二、后端代码结构（voice_community_backend）

### 2.1 技术栈
- **框架**: Spring Boot 3.3.7-SNAPSHOT
- **Java版本**: Java 21
- **数据库**: 达梦数据库（DM Database）
- **ORM框架**: MyBatis 3.0.4
- **数据库迁移**: Flyway
- **连接池**: Druid + HikariCP
- **其他依赖**: 
  - Lombok（简化代码）
  - PageHelper（分页插件）
  - Hutool（工具类库）
  - FastJSON（JSON处理）
  - 青云对象存储SDK（文件上传）

### 2.2 项目结构

```
voice_community_backend/
├── src/main/java/com/vc/
│   ├── VoiceCommunityBackendApplication.java  # 主启动类
│   ├── config/                                 # 配置类
│   │   ├── Constants.java                      # 常量配置
│   │   └── TomcatConfig.java                   # Tomcat配置
│   ├── controller/                             # 控制器层（REST API）
│   │   ├── CommentController.java              # 评论相关接口
│   │   ├── FileController.java                 # 文件上传接口
│   │   ├── UserController.java                 # 用户相关接口
│   │   ├── VoiceAtController.java              # @提醒相关接口
│   │   ├── VoiceController.java                # 声音/帖子相关接口
│   │   └── VoteController.java                 # 点赞相关接口
│   ├── service/                                # 业务逻辑层
│   │   ├── CommentService.java / CommentServiceImpl.java
│   │   ├── FileService.java / FileServiceImpl.java
│   │   ├── TagService.java / TagServiceImpl.java
│   │   ├── UserService.java / UserServiceImpl.java
│   │   ├── VoiceAtService.java / VoiceAtServiceImpl.java
│   │   ├── VoiceService.java / VoiceServiceImpl.java
│   │   ├── VoiceTagService.java / VoiceTagServiceImpl.java
│   │   └── VoteService.java / VoteServiceImpl.java
│   ├── mapper/                                 # 数据访问层（MyBatis）
│   │   ├── CommentMapper.java / CommentMapper.xml
│   │   ├── TagMapper.java / TagMapper.xml
│   │   ├── UserMapper.java / UserMapper.xml
│   │   ├── VoiceAtMapper.java / VoiceAtMapper.xml
│   │   ├── VoiceMapper.java / VoiceMapper.xml
│   │   ├── VoiceTagMapper.java / VoiceTagMapper.xml
│   │   └── VoteMapper.java / VoteMapper.xml
│   ├── pojo/                                   # 实体类和DTO
│   │   ├── entity/                             # 实体类（对应数据库表）
│   │   │   ├── User.java                        # 用户实体
│   │   │   ├── Voice.java                       # 声音/帖子实体
│   │   │   ├── Comment.java                     # 评论实体
│   │   │   ├── Vote.java                        # 点赞实体
│   │   │   ├── VoiceTag.java                    # 声音标签关联实体
│   │   │   ├── VoiceAt.java                     # @提醒实体
│   │   │   ├── Tag.java                         # 标签实体
│   │   │   ├── Role.java                        # 角色实体
│   │   │   ├── Permission.java                  # 权限实体
│   │   │   └── Organization.java                 # 组织实体
│   │   ├── dto/                                 # 数据传输对象
│   │   │   ├── CommentDTO.java
│   │   │   ├── PageResultDTO.java
│   │   │   ├── ProjectDTO.java
│   │   │   ├── SummaryDTO.java
│   │   │   ├── TagSummaryCountDTO.java
│   │   │   ├── UserDTO.java
│   │   │   └── VoiceDTO.java
│   │   └── vo/                                  # 视图对象
│   │       ├── CommentVo.java
│   │       ├── GossipingVo.java
│   │       ├── IdeaVo.java
│   │       └── PageResult.java
│   ├── handler/                                 # 处理器（异常处理等）
│   ├── schedule/                                # 定时任务
│   │   └── IAMSchedule.java                     # IAM用户数据同步
│   └── tools/                                   # 工具类
│       └── http_client/                         # HTTP客户端工具
├── src/main/resources/
│   ├── application.yml                          # 应用配置
│   ├── mybatis-config.xml                       # MyBatis配置
│   ├── logback-spring.xml                       # 日志配置
│   └── db/migration/                            # Flyway数据库迁移脚本
│       ├── V20241206__add_initial_table.sql      # 初始表结构
│       ├── V20241212__alter_commentl_table_col_default.sql
│       ├── V20241215__alter_voice_and_add_voice_tags_table.sql
│       ├── V20241217__alter_user_avatar.sql
│       ├── V20241218__init_tag_table.sql        # 初始化标签数据
│       ├── V20241219__alter_user_add_is_leader.sql
│       ├── V20241227__update_tag.sql
│       └── V20250102__update_user_table.sql
└── pom.xml                                      # Maven依赖配置
```

### 2.3 核心功能模块

#### 2.3.1 用户模块（User）
- 用户信息管理（通过OpenID获取用户）
- 用户数据同步（从IAM系统）
- 用户信息更新（头像、签名等）
- 领导用户查询

#### 2.3.2 声音/帖子模块（Voice）
- 创建声音/帖子（支持标题、内容、图片、标签）
- 查询声音列表（支持分页、筛选、排序）
  - 按类型筛选（idea/gossiping）
  - 按状态筛选
  - 按标签筛选
  - 按用户筛选
  - 排序方式：点赞数、评论数、更新时间
- 获取声音详情
- 查询用户点赞过的声音
- 查询用户评论过的声音
- 声音转项目功能

#### 2.3.3 评论模块（Comment）
- 添加评论（支持回复、图片）
- 删除评论
- 获取评论列表（支持树形结构和扁平结构）
- 评论分页查询

#### 2.3.4 点赞模块（Vote）
- 添加点赞（支持对声音和评论点赞）
- 取消点赞

#### 2.3.5 @提醒模块（VoiceAt）
- 创建@提醒
- 查询未读@提醒列表
- 标记已读

#### 2.3.6 标签模块（Tag）
- 标签管理
- 声音标签关联

#### 2.3.7 文件模块（File）
- 文件上传（支持图片等）

---

## 三、前端代码结构（voice_community_fe）

### 3.1 技术栈
- **框架**: React 18.3.1
- **语言**: TypeScript 5.6.2
- **构建工具**: Vite 5.4.10
- **状态管理**: Redux Toolkit 2.3.0 + React Redux
- **路由**: React Router DOM 6.28.0
- **UI组件库**: 
  - Ant Design 5.22.2（桌面端）
  - Ant Design Mobile 5.38.1（移动端）
- **样式**: Sass/SCSS
- **HTTP客户端**: Axios 1.7.9
- **工具库**: Lodash 4.17.21, Moment 2.30.1

### 3.2 项目结构

```
voice_community_fe/
├── src/
│   ├── main.tsx                                 # 应用入口
│   ├── App.tsx                                   # 根组件（路由配置）
│   ├── App.css                                   # 全局样式
│   ├── index.css                                 # 基础样式
│   ├── vite-env.d.ts                             # Vite类型定义
│   ├── api/                                      # API接口层
│   │   ├── api.ts                                # HTTP请求封装
│   │   └── index.ts                              # API接口定义
│   ├── app/                                      # Redux Store配置
│   │   ├── store.ts                              # Store配置
│   │   └── hooks.ts                              # Redux Hooks
│   ├── components/                               # 公共组件
│   │   ├── ip-comment/                           # 评论组件
│   │   ├── ip-header/                            # 头部组件
│   │   ├── ip-hot/                               # 热门/通知组件
│   │   ├── ip-list/                              # 列表组件
│   │   ├── ip-page-indicator/                    # 分页指示器
│   │   ├── ip-post/                              # 帖子组件
│   │   ├── ip-tab/                               # 标签页组件
│   │   └── nav-bar/                              # 底部导航栏
│   ├── pages/                                    # 页面组件
│   │   ├── home/                                 # 首页
│   │   │   ├── index.tsx
│   │   │   ├── styles.module.scss
│   │   │   └── homeSlice.ts                      # Redux Slice
│   │   ├── plaza/                                # 创新广场
│   │   │   ├── index.tsx
│   │   │   ├── styles.module.scss
│   │   │   ├── plazaSlice.ts
│   │   │   ├── create-idea/                      # 创建创意页面
│   │   │   ├── detail/                           # 创意详情页
│   │   │   ├── filter-list/                      # 筛选列表页
│   │   │   └── ranking-list/                     # 排行榜页面
│   │   ├── gossiping/                            # 员工声音/闲聊
│   │   │   ├── index.tsx
│   │   │   ├── styles.module.scss
│   │   │   ├── gossipingSlice.ts
│   │   │   ├── create-gossiping/                 # 创建声音页面
│   │   │   ├── detail/                           # 声音详情页
│   │   │   └── ranking-list/                     # 排行榜页面
│   │   └── account/                              # 个人账户
│   │       ├── index.tsx
│   │       ├── styles.module.scss
│   │       ├── accountSlice.ts
│   │       ├── messages/                         # 消息页面（@提醒）
│   │       ├── commented/                        # 我评论的
│   │       ├── created/                          # 我创建的
│   │       └── voted/                            # 我点赞的
│   ├── assets/                                   # 静态资源
│   │   └── [各种SVG图标和图片]
│   ├── utils/                                    # 工具函数
│   ├── _reset.scss                               # 样式重置
│   └── _variable.scss                            # SCSS变量
├── public/                                       # 公共资源
├── scripts/                                      # 构建脚本
│   └── build.cjs
├── package.json                                  # 依赖配置
├── tsconfig.json                                 # TypeScript配置
├── vite.config.ts                                # Vite配置
└── eslint.config.js                              # ESLint配置
```

### 3.3 核心页面功能

#### 3.3.1 首页（Home）
- 最新创意轮播展示
- 员工声音列表
- 通知提醒（@消息）

#### 3.3.2 创新广场（Plaza）
- 点赞榜/评论榜切换
- 按分类筛选（全部、枢纽、园区、补电+、其他）
- 创意项目列表
- 创建创意功能
- 创意详情页
- 排行榜页面

#### 3.3.3 员工声音（Gossiping）
- 声音列表展示
- 创建声音功能
- 声音详情页
- 排行榜页面

#### 3.3.4 个人账户（Account）
- 消息中心（@提醒）
- 我评论的
- 我创建的
- 我点赞的

---

## 四、数据库设计

### 4.1 数据库信息
- **数据库类型**: 达梦数据库（DM Database）
- **Schema**: VCDB
- **字符集**: 默认

### 4.2 数据表结构

#### 4.2.1 用户表（USER）
```sql
CREATE TABLE "USER" (
    id BIGINT IDENTITY(1,1) PRIMARY KEY,          -- 用户ID（自增）
    user_name VARCHAR(100),                       -- 用户名
    full_name VARCHAR(100),                       -- 全名
    eng_name VARCHAR(100),                        -- 英文名
    signature VARCHAR(200),                       -- 个人签名
    gender VARCHAR(20),                           -- 性别
    email_address VARCHAR(100),                   -- 邮箱
    mobile VARCHAR(20),                           -- 手机号
    nickname VARCHAR(20),                         -- 昵称
    timezone VARCHAR(40),                         -- 时区
    territory VARCHAR(40),                        -- 地区
    "LANGUAGE" VARCHAR(20),                       -- 语言
    primary_org_code VARCHAR(20),                 -- 主组织代码
    type VARCHAR(20),                             -- 用户类型
    status VARCHAR(20),                           -- 状态
    last_update_time TIMESTAMP,                   -- 最后更新时间
    openid VARCHAR(100),                          -- 微信OpenID
    avator VARCHAR(500),                          -- 头像URL
    voted INT,                                    -- 点赞数统计
    created INT,                                  -- 创建数统计
    commented INT,                                -- 评论数统计
    score INT DEFAULT 0,                          -- 积分
    active BIT DEFAULT 1,                         -- 是否激活
    is_deleted BIT DEFAULT 0,                     -- 是否删除
    is_leader BIT DEFAULT 0,                      -- 是否领导
    create_time TIMESTAMP,                        -- 创建时间
    update_time TIMESTAMP                          -- 更新时间
);
```

#### 4.2.2 声音表（voice）
```sql
CREATE TABLE voice (
    id BIGINT IDENTITY(1,1) PRIMARY KEY,          -- 声音ID（自增）
    user_id BIGINT NOT NULL,                      -- 用户ID（外键）
    title VARCHAR(100),                           -- 标题
    content VARCHAR(5000),                        -- 内容
    commented INT,                                -- 评论数
    voted INT,                                    -- 点赞数
    type VARCHAR(10),                             -- 类型（idea/gossiping）
    status VARCHAR(20),                           -- 状态
    images TEXT,                                  -- 图片（JSON格式）
    is_deleted BIT DEFAULT 0,                     -- 是否删除
    create_time TIMESTAMP,                        -- 创建时间
    update_time TIMESTAMP                          -- 更新时间
);
```

#### 4.2.3 评论表（COMMENT）
```sql
CREATE TABLE "COMMENT" (
    id BIGINT IDENTITY(1,1) PRIMARY KEY,          -- 评论ID（自增）
    content VARCHAR(5000),                        -- 评论内容
    voice_id BIGINT,                              -- 声音ID（外键）
    user_id BIGINT,                               -- 用户ID（外键）
    comment_id BIGINT,                            -- 父评论ID（支持回复）
    voted INT,                                    -- 点赞数
    commented INT,                                -- 回复数
    images TEXT,                                  -- 图片（JSON格式）
    is_deleted BIT DEFAULT 0,                     -- 是否删除
    create_time TIMESTAMP,                        -- 创建时间
    update_time TIMESTAMP                          -- 更新时间
);
```

#### 4.2.4 点赞表（vote）
```sql
CREATE TABLE vote (
    id BIGINT IDENTITY(1,1) PRIMARY KEY,          -- 点赞ID（自增）
    user_id BIGINT,                               -- 用户ID（外键）
    voice_id BIGINT,                              -- 声音ID（外键，可为空）
    comment_id BIGINT,                            -- 评论ID（外键，可为空）
    create_time TIMESTAMP,                        -- 创建时间
    update_time TIMESTAMP                          -- 更新时间
);
```

#### 4.2.5 标签表（tag）
```sql
CREATE TABLE tag (
    id INT IDENTITY(1,1) PRIMARY KEY,             -- 标签ID（自增）
    name VARCHAR(50) NOT NULL,                    -- 标签名称
    create_time TIMESTAMP,                        -- 创建时间
    update_time TIMESTAMP                          -- 更新时间
);

-- 初始标签数据：
-- 1. 楼宇（枢纽）
-- 2. 园区
-- 3. 补电+
-- 4. 其他
```

#### 4.2.6 声音标签关联表（voice_tag）
```sql
CREATE TABLE voice_tag (
    id BIGINT IDENTITY(1,1) PRIMARY KEY,          -- 关联ID（自增）
    voice_id BIGINT,                              -- 声音ID（外键）
    tag_id INT,                                   -- 标签ID（外键）
    create_time TIMESTAMP,                        -- 创建时间
    update_time TIMESTAMP                          -- 更新时间
);
```

#### 4.2.7 @提醒表（voice_at）
```sql
CREATE TABLE voice_at (
    id BIGINT IDENTITY(1,1) PRIMARY KEY,          -- 提醒ID（自增）
    voice_id BIGINT,                              -- 声音ID（外键）
    user_id BIGINT,                               -- 被@的用户ID（外键）
    is_read BIT DEFAULT 0,                       -- 是否已读
    create_time TIMESTAMP,                        -- 创建时间
    update_time TIMESTAMP                          -- 更新时间
);
```

#### 4.2.8 角色表（ROLE）
```sql
CREATE TABLE "ROLE" (
    id INT PRIMARY KEY,                           -- 角色ID
    name VARCHAR(20),                             -- 角色名称
    create_time TIMESTAMP,                        -- 创建时间
    update_time TIMESTAMP                          -- 更新时间
);
```

#### 4.2.9 用户角色关联表（user_role）
```sql
CREATE TABLE user_role (
    id INT PRIMARY KEY,                           -- 关联ID
    user_id BIGINT,                               -- 用户ID（外键）
    role_id INT                                  -- 角色ID（外键）
);
```

#### 4.2.10 权限表（permission）
```sql
CREATE TABLE permission (
    id INT PRIMARY KEY,                           -- 权限ID
    name VARCHAR(20),                             -- 权限名称
    create_time TIMESTAMP,                        -- 创建时间
    update_time TIMESTAMP                          -- 更新时间
);
```

#### 4.2.11 角色权限关联表（role_permission）
```sql
CREATE TABLE role_permission (
    id INT IDENTITY(1,1) PRIMARY KEY,             -- 关联ID（自增）
    role_id INT,                                  -- 角色ID（外键）
    permission_id INT,                            -- 权限ID（外键）
    create_time TIMESTAMP,                        -- 创建时间
    update_time TIMESTAMP                          -- 更新时间
);
```

### 4.3 数据库关系图

```
USER (用户)
  ├── 1:N → voice (创建的声音)
  ├── 1:N → COMMENT (发表的评论)
  ├── 1:N → vote (点赞记录)
  ├── 1:N → voice_at (被@的记录)
  └── N:M → ROLE (通过user_role关联)

voice (声音)
  ├── N:1 → USER (创建者)
  ├── 1:N → COMMENT (评论)
  ├── 1:N → vote (点赞)
  ├── 1:N → voice_at (@提醒)
  └── N:M → tag (通过voice_tag关联)

COMMENT (评论)
  ├── N:1 → voice (所属声音)
  ├── N:1 → USER (评论者)
  ├── 1:N → COMMENT (回复，自关联)
  └── 1:N → vote (点赞)

tag (标签)
  └── N:M → voice (通过voice_tag关联)

ROLE (角色)
  ├── N:M → USER (通过user_role关联)
  └── N:M → permission (通过role_permission关联)
```

### 4.4 数据库设计特点

1. **软删除机制**: 主要表都包含`is_deleted`字段，支持逻辑删除
2. **统计字段**: 用户表和声音表包含统计字段（voted、commented、created），减少关联查询
3. **多对多关系**: 使用中间表实现（voice_tag、user_role、role_permission）
4. **时间戳**: 所有表都包含`create_time`和`update_time`字段
5. **自增主键**: 使用`IDENTITY(1,1)`实现自增
6. **类型区分**: voice表通过`type`字段区分"创意"（idea）和"声音"（gossiping）

---

## 五、核心业务流程

### 5.1 用户认证流程
1. 用户通过微信/企业微信登录
2. 前端获取code参数
3. 调用`/user/getUserByCode`接口
4. 后端通过OpenID查询或创建用户
5. 返回用户信息给前端

### 5.2 发布声音/创意流程
1. 用户填写标题、内容、选择标签、上传图片
2. 前端调用`/voice/add`接口
3. 后端保存声音数据
4. 如果有@用户，创建voice_at记录
5. 关联标签到voice_tag表
6. 更新用户统计字段（created）

### 5.3 评论流程
1. 用户在声音详情页输入评论
2. 前端调用`/comment/add`接口
3. 后端保存评论数据
4. 更新声音的评论数（commented）
5. 更新用户的评论数统计

### 5.4 点赞流程
1. 用户点击点赞按钮
2. 前端调用`/vote/add`接口
3. 后端检查是否已点赞
4. 创建vote记录
5. 更新声音/评论的点赞数（voted）
6. 更新用户的点赞数统计

### 5.5 @提醒流程
1. 发布声音时@用户
2. 创建voice_at记录（is_read=0）
3. 用户查看消息列表
4. 调用`/voice/getUnreadVoicesByAtUserId`接口
5. 标记已读（is_read=1）

---

## 六、技术亮点

### 6.1 后端
- ✅ 使用Flyway进行数据库版本管理
- ✅ MyBatis实现灵活的SQL查询
- ✅ PageHelper实现分页功能
- ✅ 支持多种排序和筛选条件
- ✅ 文件上传到对象存储（青云）
- ✅ 定时任务同步IAM用户数据

### 6.2 前端
- ✅ Redux Toolkit进行状态管理
- ✅ TypeScript提供类型安全
- ✅ 移动端适配（Ant Design Mobile）
- ✅ 路由懒加载
- ✅ 组件化开发

---

## 七、总结

这是一个**企业内部创新社区系统**，主要功能包括：
- 📝 发布创意想法和员工声音
- 💬 评论和回复
- 👍 点赞功能
- 🏷️ 标签分类
- @ 提醒功能
- 📊 排行榜和统计
- 👤 用户个人中心

系统采用前后端分离架构，后端使用Spring Boot + MyBatis，前端使用React + TypeScript，数据库使用达梦数据库，整体架构清晰，功能完善。





