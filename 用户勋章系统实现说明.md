# 用户勋章系统实现说明

## 一、实现概览

已按照"DB → 后端 → 前端 → 规则示例"的完整链路实现了用户勋章系统。

## 二、数据库设计

### 2.1 新增表结构

#### medal（勋章定义表）
- 存储勋章的基本信息、授予条件、图标等
- 支持自动授予（AUTO）、手动授予（MANUAL）、混合模式（MIXED）
- 通过简单阈值条件（min_score、min_created、min_commented、min_voted）判断是否授予

#### user_medal（用户勋章关联表）
- 记录用户获得的勋章
- 支持过期时间、授予来源（AUTO/MANUAL/EVENT）
- 使用唯一索引防止重复授予

### 2.2 迁移脚本
- 文件：`V20250110__add_medal_tables.sql`
- 包含表结构、索引、初始数据

## 三、后端实现

### 3.1 实体类
- `Medal.java` - 勋章实体
- `UserMedal.java` - 用户勋章关联实体

### 3.2 Mapper层
- `MedalMapper.java` / `MedalMapper.xml` - 勋章数据访问
- `UserMedalMapper.java` / `UserMedalMapper.xml` - 用户勋章数据访问

### 3.3 Service层
- `MedalService` / `MedalServiceImpl` - 勋章业务逻辑
  - `getUserMedals()` - 获取用户勋章列表
  - `grantMedalManually()` - 手动授予勋章
  - `evaluateAndGrantMedals()` - 自动评估并授予勋章

### 3.4 集成点
已在以下Service中集成勋章评估：
- `VoiceServiceImpl.addVoice()` - 发帖后评估
- `CommentServiceImpl.addComment()` - 评论后评估
- `VoteServiceImpl.addVote()` - 点赞后评估

### 3.5 Controller
- `MedalController` - 提供REST API
  - `GET /medal/my?userId={userId}` - 获取用户勋章
  - `POST /medal/grant` - 管理员授予勋章

### 3.6 定时任务
- `MedalSchedule` - 每天凌晨2点全量评估所有用户勋章（兜底机制）

## 四、前端实现

### 4.1 API层
- `fetchMyMedals(userId)` - 获取用户勋章
- `grantMedal(data)` - 授予勋章（管理用）

### 4.2 Redux状态管理
- `accountSlice.ts` - 扩展了medals状态
- `loadMyMedals` - 异步加载用户勋章

### 4.3 组件
- `ip-medal/index.tsx` - 勋章展示组件
  - 支持small/normal两种尺寸
  - 支持最大显示数量限制
  - 超出部分显示"+N"

### 4.4 页面集成
- `Account`页面 - 已集成勋章展示区域
  - 使用Grid布局展示所有勋章
  - 显示勋章图标和名称

## 五、初始勋章数据

系统预置了6个勋章：

1. **初声一鸣** (FIRST_POST)
   - 条件：发布1条声音/创意
   - 类型：自动授予

2. **创意达人** (IDEA_MASTER)
   - 条件：累计发布20条以上
   - 类型：自动授予

3. **社交之星** (SOCIAL_STAR)
   - 条件：累计评论50条以上
   - 类型：自动授予

4. **人气之声** (POPULAR_VOICE)
   - 条件：累计获得点赞100次以上
   - 类型：自动授予

5. **百强贡献者** (TOP100)
   - 条件：积分1000以上（预留，需手动授予）
   - 类型：手动授予

6. **领航导师** (LEADER_MENTOR)
   - 条件：领导身份 + 积分500以上
   - 类型：自动授予

## 六、使用说明

### 6.1 自动授予流程
1. 用户执行行为（发帖/评论/点赞）
2. 系统更新用户统计字段
3. 调用`medalService.evaluateAndGrantMedals()`
4. 系统检查所有启用勋章的条件
5. 满足条件则自动授予

### 6.2 手动授予
管理员可通过API授予勋章：
```bash
POST /medal/grant
{
  "userId": 123,
  "medalId": 5,
  "remark": "年度最佳创意"
}
```

### 6.3 前端展示
- 个人中心页面显示所有勋章
- 评论/帖子列表可显示用户勋章（需后端VO中携带medal信息）

## 七、扩展建议

### 7.1 性能优化
- 对`selectEnabledMedals()`结果进行缓存（Redis或本地缓存）
- 勋章数量一般不会太多，内存过滤即可

### 7.2 功能扩展
- 勋章过期机制（已支持expire_time字段）
- 勋章积分奖励（授予时自动加分）
- 复杂规则表达式（可新增medal_rule表）
- 勋章等级系统（铜/银/金）

### 7.3 运营玩法
- 年度勋章评选
- 活动限时勋章
- 勋章排行榜
- 勋章兑换功能

## 八、注意事项

1. **幂等性**：通过唯一索引和existsUserMedal检查保证不重复授予
2. **异常处理**：evaluateAndGrantMedals中捕获异常，不影响主业务流程
3. **性能考虑**：勋章评估是异步的，不会阻塞用户操作
4. **数据一致性**：依赖USER表的统计字段，确保统计准确

## 九、文件清单

### 数据库
- `V20250110__add_medal_tables.sql`

### 后端
- `Medal.java`
- `UserMedal.java`
- `MedalMapper.java` / `MedalMapper.xml`
- `UserMedalMapper.java` / `UserMedalMapper.xml`
- `MedalService.java` / `MedalServiceImpl.java`
- `MedalController.java`
- `MedalSchedule.java`
- `VoiceServiceImpl.java` (已修改)
- `CommentServiceImpl.java` (已修改)
- `VoteServiceImpl.java` (已修改)

### 前端
- `api/index.ts` (已修改)
- `pages/account/accountSlice.ts` (已修改)
- `pages/account/index.tsx` (已修改)
- `pages/account/styles.module.scss` (已修改)
- `components/ip-medal/index.tsx` (新建)
- `components/ip-medal/styles.module.scss` (新建)

---

**实现完成时间**: 2025-11-23
**版本**: v1.0




