# 语音社区系统 - 数据库表结构设计文档

## 文档信息
- **数据库类型**: 达梦数据库 (DM Database)
- **Schema**: VCDB
- **字符集**: UTF-8
- **文档版本**: v1.0
- **最后更新**: 2025-01-02

---

## 目录
1. [表结构概览](#表结构概览)
2. [核心业务表](#核心业务表)
3. [关联关系表](#关联关系表)
4. [权限管理表](#权限管理表)
5. [表关系图](#表关系图)
6. [索引设计](#索引设计)
7. [数据字典](#数据字典)

---

## 表结构概览

| 序号 | 表名 | 中文名称 | 说明 | 记录数预估 |
|------|------|---------|------|-----------|
| 1 | USER | 用户表 | 存储用户基本信息 | 1000+ |
| 2 | voice | 声音/帖子表 | 存储创意和声音内容 | 10000+ |
| 3 | COMMENT | 评论表 | 存储评论和回复 | 50000+ |
| 4 | vote | 点赞表 | 存储点赞记录 | 100000+ |
| 5 | tag | 标签表 | 存储标签信息 | 4 |
| 6 | voice_tag | 声音标签关联表 | 声音与标签的多对多关系 | 20000+ |
| 7 | voice_at | @提醒表 | 存储@用户提醒记录 | 5000+ |
| 8 | ROLE | 角色表 | 存储角色信息 | 10 |
| 9 | user_role | 用户角色关联表 | 用户与角色的多对多关系 | 100+ |
| 10 | permission | 权限表 | 存储权限信息 | 50 |
| 11 | role_permission | 角色权限关联表 | 角色与权限的多对多关系 | 100+ |

---

## 核心业务表

### 1. USER（用户表）

**表说明**: 存储系统用户的基本信息，包括个人资料、统计数据等。

| 字段名 | 数据类型 | 长度 | 是否可空 | 默认值 | 主键 | 说明 |
|--------|---------|------|---------|--------|------|------|
| id | BIGINT | - | NOT NULL | IDENTITY(1,1) | ✅ | 用户ID，自增主键 |
| user_name | VARCHAR | 100 | NULL | - | - | 用户名 |
| full_name | VARCHAR | 100 | NULL | - | - | 全名 |
| eng_name | VARCHAR | 100 | NULL | - | - | 英文名 |
| signature | VARCHAR | 200 | NULL | - | - | 个人签名 |
| gender | VARCHAR | 20 | NULL | - | - | 性别 |
| email_address | VARCHAR | 100 | NULL | - | - | 邮箱地址 |
| mobile | VARCHAR | 20 | NULL | - | - | 手机号 |
| nickname | VARCHAR | 20 | NULL | - | - | 昵称 |
| timezone | VARCHAR | 40 | NULL | - | - | 时区 |
| territory | VARCHAR | 40 | NULL | - | - | 地区 |
| LANGUAGE | VARCHAR | 20 | NULL | - | - | 语言 |
| primary_org_code | VARCHAR | 20 | NULL | - | - | 主组织代码 |
| type | VARCHAR | 20 | NULL | - | - | 用户类型 |
| status | VARCHAR | 20 | NULL | - | - | 用户状态 |
| last_update_time | TIMESTAMP | - | NULL | - | - | 最后更新时间（IAM同步） |
| openid | VARCHAR | 100 | NULL | - | - | 微信OpenID，用于登录认证 |
| avatar | VARCHAR | 500 | NULL | - | - | 头像URL |
| voted | INT | - | NULL | - | - | 点赞数统计 |
| created | INT | - | NULL | - | - | 创建数统计 |
| commented | INT | - | NULL | - | - | 评论数统计 |
| score | INT | - | NULL | 0 | - | 积分 |
| active | BIT | - | NULL | 1 | - | 是否激活 |
| is_deleted | BIT | - | NULL | 0 | - | 是否删除（软删除） |
| is_leader | BIT | - | NULL | 0 | - | 是否领导 |
| create_time | TIMESTAMP | - | NULL | - | - | 创建时间 |
| update_time | TIMESTAMP | - | NULL | - | - | 更新时间 |

**索引设计**:
- 主键索引: `PRIMARY KEY (id)`
- 建议索引: `openid` (用于登录查询)
- 建议索引: `is_deleted` (用于软删除查询)

**业务规则**:
- `openid` 用于微信/企业微信登录认证
- `voted`、`created`、`commented` 为统计字段，减少关联查询
- `is_deleted = 1` 表示已删除，采用软删除机制

---

### 2. voice（声音/帖子表）

**表说明**: 存储用户发布的创意想法和员工声音内容。

| 字段名 | 数据类型 | 长度 | 是否可空 | 默认值 | 主键 | 说明 |
|--------|---------|------|---------|--------|------|------|
| id | BIGINT | - | NOT NULL | IDENTITY(1,1) | ✅ | 声音ID，自增主键 |
| user_id | BIGINT | - | NOT NULL | - | - | 用户ID（外键→USER.id） |
| title | VARCHAR | 100 | NULL | - | - | 标题 |
| content | VARCHAR | 5000 | NULL | - | - | 内容 |
| commented | INT | - | NULL | - | - | 评论数统计 |
| voted | INT | - | NULL | - | - | 点赞数统计 |
| type | VARCHAR | 10 | NULL | - | - | 类型：idea（创意）/gossiping（声音） |
| status | VARCHAR | 20 | NULL | - | - | 状态：draft/published/project等 |
| images | TEXT | - | NULL | - | - | 图片列表（JSON格式） |
| is_deleted | BIT | - | NULL | 0 | - | 是否删除（软删除） |
| create_time | TIMESTAMP | - | NULL | - | - | 创建时间 |
| update_time | TIMESTAMP | - | NULL | - | - | 更新时间 |

**索引设计**:
- 主键索引: `PRIMARY KEY (id)`
- 外键索引: `user_id` (关联USER表)
- 建议索引: `type` (用于类型筛选)
- 建议索引: `status` (用于状态筛选)
- 建议索引: `create_time` (用于时间排序)
- 建议索引: `update_time` (用于更新时间排序)
- 建议索引: `is_deleted` (用于软删除查询)

**业务规则**:
- `type` 字段区分创意（idea）和声音（gossiping）
- `status` 字段表示声音状态，如：草稿、已发布、已转为项目等
- `images` 字段存储JSON格式的图片URL数组
- `commented` 和 `voted` 为统计字段，减少关联查询

---

### 3. COMMENT（评论表）

**表说明**: 存储对声音的评论和回复，支持多级回复。

| 字段名 | 数据类型 | 长度 | 是否可空 | 默认值 | 主键 | 说明 |
|--------|---------|------|---------|--------|------|------|
| id | BIGINT | - | NOT NULL | IDENTITY(1,1) | ✅ | 评论ID，自增主键 |
| content | VARCHAR | 5000 | NULL | - | - | 评论内容 |
| voice_id | BIGINT | - | NULL | - | - | 声音ID（外键→voice.id） |
| user_id | BIGINT | - | NULL | - | - | 评论用户ID（外键→USER.id） |
| user_id_commented | BIGINT | - | NULL | 0 | - | 被回复的用户ID（外键→USER.id） |
| comment_id | BIGINT | - | NULL | 0 | - | 父评论ID（外键→COMMENT.id，0表示顶级评论） |
| voted | INT | - | NULL | - | - | 点赞数统计 |
| commented | INT | - | NULL | - | - | 回复数统计 |
| images | TEXT | - | NULL | - | - | 图片列表（JSON格式） |
| is_deleted | BIT | - | NULL | 0 | - | 是否删除（软删除） |
| create_time | TIMESTAMP | - | NULL | - | - | 创建时间 |
| update_time | TIMESTAMP | - | NULL | - | - | 更新时间 |

**索引设计**:
- 主键索引: `PRIMARY KEY (id)`
- 外键索引: `voice_id` (关联voice表)
- 外键索引: `user_id` (关联USER表)
- 外键索引: `comment_id` (自关联，用于树形结构)
- 建议索引: `is_deleted` (用于软删除查询)
- 建议索引: `create_time` (用于时间排序)

**业务规则**:
- `comment_id = 0` 表示顶级评论，`comment_id > 0` 表示回复
- 通过 `comment_id` 自关联实现多级回复
- `user_id_commented` 记录被回复的用户，用于@提醒
- `commented` 字段统计该评论的回复数

---

### 4. vote（点赞表）

**表说明**: 存储用户对声音或评论的点赞记录。

| 字段名 | 数据类型 | 长度 | 是否可空 | 默认值 | 主键 | 说明 |
|--------|---------|------|---------|--------|------|------|
| id | BIGINT | - | NOT NULL | IDENTITY(1,1) | ✅ | 点赞ID，自增主键 |
| user_id | BIGINT | - | NULL | - | - | 用户ID（外键→USER.id） |
| voice_id | BIGINT | - | NULL | 0 | - | 声音ID（外键→voice.id，0表示不是对声音点赞） |
| comment_id | BIGINT | - | NULL | 0 | - | 评论ID（外键→COMMENT.id，0表示不是对评论点赞） |
| create_time | TIMESTAMP | - | NULL | - | - | 创建时间 |
| update_time | TIMESTAMP | - | NULL | - | - | 更新时间 |

**索引设计**:
- 主键索引: `PRIMARY KEY (id)`
- 外键索引: `user_id` (关联USER表)
- 外键索引: `voice_id` (关联voice表)
- 外键索引: `comment_id` (关联COMMENT表)
- **唯一索引**: `(user_id, voice_id, comment_id)` (防止重复点赞)

**业务规则**:
- `voice_id` 和 `comment_id` 至少有一个不为0
- 同一用户对同一对象只能点赞一次（通过唯一索引保证）
- 取消点赞时删除对应记录

---

## 关联关系表

### 5. tag（标签表）

**表说明**: 存储系统标签信息，用于分类声音。

| 字段名 | 数据类型 | 长度 | 是否可空 | 默认值 | 主键 | 说明 |
|--------|---------|------|---------|--------|------|------|
| id | INT | - | NOT NULL | IDENTITY(1,1) | ✅ | 标签ID，自增主键 |
| name | VARCHAR | 50 | NOT NULL | - | - | 标签名称 |
| create_time | TIMESTAMP | - | NULL | - | - | 创建时间 |
| update_time | TIMESTAMP | - | NULL | - | - | 更新时间 |

**索引设计**:
- 主键索引: `PRIMARY KEY (id)`
- 唯一索引: `name` (标签名称唯一)

**初始数据**:
- id=1: 枢纽
- id=2: 园区
- id=3: 补电+
- id=4: 其他

---

### 6. voice_tag（声音标签关联表）

**表说明**: 声音与标签的多对多关联表。

| 字段名 | 数据类型 | 长度 | 是否可空 | 默认值 | 主键 | 说明 |
|--------|---------|------|---------|--------|------|------|
| id | BIGINT | - | NOT NULL | IDENTITY(1,1) | ✅ | 关联ID，自增主键 |
| voice_id | BIGINT | - | NULL | - | - | 声音ID（外键→voice.id） |
| tag_id | INT | - | NULL | - | - | 标签ID（外键→tag.id） |
| create_time | TIMESTAMP | - | NULL | - | - | 创建时间 |
| update_time | TIMESTAMP | - | NULL | - | - | 更新时间 |

**索引设计**:
- 主键索引: `PRIMARY KEY (id)`
- 外键索引: `voice_id` (关联voice表)
- 外键索引: `tag_id` (关联tag表)
- **唯一索引**: `(voice_id, tag_id)` (防止重复关联)

**业务规则**:
- 一个声音可以有多个标签
- 一个标签可以关联多个声音
- 通过唯一索引防止重复关联

---

### 7. voice_at（@提醒表）

**表说明**: 存储发布声音时@用户的提醒记录。

| 字段名 | 数据类型 | 长度 | 是否可空 | 默认值 | 主键 | 说明 |
|--------|---------|------|---------|--------|------|------|
| id | BIGINT | - | NOT NULL | IDENTITY(1,1) | ✅ | 提醒ID，自增主键 |
| voice_id | BIGINT | - | NULL | - | - | 声音ID（外键→voice.id） |
| user_id | BIGINT | - | NULL | - | - | 被@的用户ID（外键→USER.id） |
| is_read | BIT | - | NULL | 0 | - | 是否已读 |
| create_time | TIMESTAMP | - | NULL | - | - | 创建时间 |
| update_time | TIMESTAMP | - | NULL | - | - | 更新时间 |

**索引设计**:
- 主键索引: `PRIMARY KEY (id)`
- 外键索引: `voice_id` (关联voice表)
- 外键索引: `user_id` (关联USER表)
- 建议索引: `(user_id, is_read)` (用于查询未读提醒)

**业务规则**:
- `is_read = 0` 表示未读，`is_read = 1` 表示已读
- 用于消息中心显示@提醒
- 用户查看后更新 `is_read = 1`

---

## 权限管理表

### 8. ROLE（角色表）

**表说明**: 存储系统角色信息（RBAC权限管理）。

| 字段名 | 数据类型 | 长度 | 是否可空 | 默认值 | 主键 | 说明 |
|--------|---------|------|---------|--------|------|------|
| id | INT | - | NOT NULL | - | ✅ | 角色ID，主键（非自增） |
| name | VARCHAR | 20 | NULL | - | - | 角色名称 |
| create_time | TIMESTAMP | - | NULL | - | - | 创建时间 |
| update_time | TIMESTAMP | - | NULL | - | - | 更新时间 |

**索引设计**:
- 主键索引: `PRIMARY KEY (id)`

**说明**: 当前系统暂无后台管理，为冗余设计，后续可扩展。

---

### 9. user_role（用户角色关联表）

**表说明**: 用户与角色的多对多关联表。

| 字段名 | 数据类型 | 长度 | 是否可空 | 默认值 | 主键 | 说明 |
|--------|---------|------|---------|--------|------|------|
| id | INT | - | NOT NULL | - | ✅ | 关联ID，主键（非自增） |
| user_id | BIGINT | - | NULL | - | - | 用户ID（外键→USER.id） |
| role_id | INT | - | NULL | - | - | 角色ID（外键→ROLE.id） |

**索引设计**:
- 主键索引: `PRIMARY KEY (id)`
- 外键索引: `user_id` (关联USER表)
- 外键索引: `role_id` (关联ROLE表)

---

### 10. permission（权限表）

**表说明**: 存储系统权限信息。

| 字段名 | 数据类型 | 长度 | 是否可空 | 默认值 | 主键 | 说明 |
|--------|---------|------|---------|--------|------|------|
| id | INT | - | NOT NULL | - | ✅ | 权限ID，主键（非自增） |
| name | VARCHAR | 20 | NULL | - | - | 权限名称 |
| create_time | TIMESTAMP | - | NULL | - | - | 创建时间 |
| update_time | TIMESTAMP | - | NULL | - | - | 更新时间 |

**索引设计**:
- 主键索引: `PRIMARY KEY (id)`

---

### 11. role_permission（角色权限关联表）

**表说明**: 角色与权限的多对多关联表。

| 字段名 | 数据类型 | 长度 | 是否可空 | 默认值 | 主键 | 说明 |
|--------|---------|------|---------|--------|------|------|
| id | INT | - | NOT NULL | IDENTITY(1,1) | ✅ | 关联ID，自增主键 |
| role_id | INT | - | NULL | - | - | 角色ID（外键→ROLE.id） |
| permission_id | INT | - | NULL | - | - | 权限ID（外键→permission.id） |
| create_time | TIMESTAMP | - | NULL | - | - | 创建时间 |
| update_time | TIMESTAMP | - | NULL | - | - | 更新时间 |

**索引设计**:
- 主键索引: `PRIMARY KEY (id)`
- 外键索引: `role_id` (关联ROLE表)
- 外键索引: `permission_id` (关联permission表)

---

## 表关系图

```
USER (用户)
  ├── 1:N → voice (创建的声音)
  │       ├── 1:N → COMMENT (评论)
  │       ├── 1:N → vote (点赞)
  │       ├── 1:N → voice_at (@提醒)
  │       └── N:M → tag (通过voice_tag关联)
  │
  ├── 1:N → COMMENT (发表的评论)
  ├── 1:N → vote (点赞记录)
  ├── 1:N → voice_at (被@的记录)
  └── N:M → ROLE (通过user_role关联)

COMMENT (评论)
  ├── N:1 → voice (所属声音)
  ├── N:1 → USER (评论者)
  ├── 1:N → COMMENT (回复，自关联)
  └── 1:N → vote (点赞)

tag (标签)
  └── N:M → voice (通过voice_tag关联)

ROLE (角色)
  ├── N:M → USER (通过user_role关联)
  └── N:M → permission (通过role_permission关联)
```

---

## 索引设计

### 主键索引
所有表都有主键索引，使用 `PRIMARY KEY` 定义。

### 外键索引
所有外键字段建议创建索引，提高关联查询性能。

### 业务索引建议

| 表名 | 索引字段 | 索引类型 | 说明 |
|------|---------|---------|------|
| USER | openid | 唯一索引 | 登录查询 |
| USER | is_deleted | 普通索引 | 软删除查询 |
| voice | user_id | 普通索引 | 用户声音列表 |
| voice | type | 普通索引 | 类型筛选 |
| voice | status | 普通索引 | 状态筛选 |
| voice | create_time | 普通索引 | 时间排序 |
| voice | update_time | 普通索引 | 更新时间排序 |
| COMMENT | voice_id | 普通索引 | 声音评论列表 |
| COMMENT | user_id | 普通索引 | 用户评论列表 |
| COMMENT | comment_id | 普通索引 | 回复查询 |
| vote | (user_id, voice_id, comment_id) | 唯一索引 | 防止重复点赞 |
| voice_tag | (voice_id, tag_id) | 唯一索引 | 防止重复关联 |
| voice_at | (user_id, is_read) | 复合索引 | 未读提醒查询 |

---

## 数据字典

### 枚举值说明

#### voice.type（声音类型）
- `idea`: 创意
- `gossiping`: 员工声音/闲聊

#### voice.status（声音状态）
- `draft`: 草稿
- `published`: 已发布
- `project`: 已转为项目
- 其他自定义状态

#### USER.status（用户状态）
- 由IAM系统同步，具体值待定

#### USER.type（用户类型）
- 由IAM系统同步，具体值待定

#### USER.gender（性别）
- `male`: 男
- `female`: 女
- 其他

---

## 数据库设计特点

### 1. 软删除机制
- 主要业务表（USER、voice、COMMENT）都包含 `is_deleted` 字段
- 删除操作不物理删除数据，只标记 `is_deleted = 1`
- 查询时过滤 `is_deleted = 0` 的记录

### 2. 统计字段优化
- USER表：`voted`、`created`、`commented` 统计用户行为
- voice表：`commented`、`voted` 统计声音互动
- COMMENT表：`voted`、`commented` 统计评论互动
- 减少关联查询，提高性能

### 3. 时间戳字段
- 所有表都包含 `create_time` 和 `update_time`
- 用于记录创建和更新时间
- 支持时间排序和查询

### 4. 自增主键
- 使用 `IDENTITY(1,1)` 实现自增
- 主键类型：业务表使用 `BIGINT`，关联表使用 `INT`

### 5. 多对多关系
- 使用中间表实现多对多关系
- `voice_tag`: 声音与标签
- `user_role`: 用户与角色
- `role_permission`: 角色与权限

### 6. 树形结构
- COMMENT表通过 `comment_id` 自关联实现多级回复
- `comment_id = 0` 表示顶级评论

---

## 数据库迁移历史

| 版本 | 日期 | 说明 |
|------|------|------|
| V20241206 | 2024-12-06 | 初始表结构创建 |
| V20241212 | 2024-12-12 | 修改COMMENT表默认值 |
| V20241215 | 2024-12-15 | 移除voice.tags字段，创建voice_tag表 |
| V20241217 | 2024-12-17 | 修改USER.avator为avatar |
| V20241218 | 2024-12-18 | 初始化tag表数据 |
| V20241219 | 2024-12-19 | USER表添加is_leader字段 |
| V20241227 | 2024-12-27 | 更新tag表数据（楼宇→枢纽） |
| V20250102 | 2025-01-02 | 更新USER表（IDENTITY_INSERT） |

---

## 注意事项

1. **字符集**: 数据库字符集必须为UTF-8，否则中文会乱码
2. **大小写敏感**: 达梦数据库表名和字段名区分大小写
3. **保留字**: USER、COMMENT、ROLE为SQL保留字，需要使用双引号
4. **外键约束**: 当前设计未显式定义外键约束，由应用层保证数据一致性
5. **索引优化**: 根据实际查询场景调整索引策略
6. **数据备份**: 定期备份数据库，特别是用户数据和声音内容

---

## 附录

### SQL创建脚本位置
- 初始表结构: `voice_community_backend/src/main/resources/db/migration/V20241206__add_initial_table.sql`
- 后续迁移: `voice_community_backend/src/main/resources/db/migration/`

### 相关文档
- 项目分析报告: `项目分析报告.md`
- 部署指南: `deploy/部署指南.md`

---

**文档结束**




