# 语音社区系统部署指南

## 目录
- [环境要求](#环境要求)
- [本地开发环境部署](#本地开发环境部署)
- [服务器部署](#服务器部署)
- [配置说明](#配置说明)
- [常见问题](#常见问题)

---

## 环境要求

### 后端环境
- **Java**: JDK 21
- **Maven**: 3.6+
- **数据库**: 达梦数据库 8.1.3+
- **操作系统**: Linux/Unix (服务器), macOS/Windows (本地开发)

### 前端环境
- **Node.js**: 18.0+
- **npm**: 9.0+
- **Nginx**: 1.18+ (生产环境)

---

## 本地开发环境部署

### 1. 后端本地启动

#### 方式一：使用脚本（推荐）
```bash
cd deploy
chmod +x start-backend-local.sh
./start-backend-local.sh
```

#### 方式二：手动启动
```bash
cd voice_community_backend

# 构建项目
mvn clean package -DskipTests

# 启动服务
java -jar target/voice_community_backend-0.0.1-SNAPSHOT.jar
```

服务将在 `http://localhost:8081` 启动

### 2. 前端本地启动

#### 方式一：使用脚本（推荐）
```bash
cd deploy
chmod +x start-frontend-local.sh
./start-frontend-local.sh
```

#### 方式二：手动启动
```bash
cd voice_community_fe

# 安装依赖（首次运行）
npm install

# 启动开发服务器
npm run dev
```

前端将在 `http://localhost:5173` 启动（端口可能不同，查看终端输出）

### 3. 数据库配置

#### 修改数据库连接
编辑 `voice_community_backend/src/main/resources/application.yml`:
```yaml
spring:
  datasource:
    url: jdbc:dm://your-db-host:5236?schema=VCDB
    username: YOUR_USERNAME
    password: YOUR_PASSWORD
```

#### 修改Flyway配置
编辑 `voice_community_backend/conf/flyway.conf`:
```properties
flyway.url=jdbc:dm://your-db-host:5236?schema=VCDB
flyway.user=YOUR_USERNAME
flyway.password=YOUR_PASSWORD
```

#### 初始化数据库
```bash
cd voice_community_backend
mvn flyway:migrate
```

---

## 服务器部署

### 前置准备

1. **服务器环境检查**
   ```bash
   # 检查Java
   /usr/local/java/jdk-21.0.3/bin/java -version
   
   # 检查Maven
   mvn -version
   
   # 检查Node.js
   node -v
   npm -v
   
   # 检查Nginx
   /usr/local/nginx/sbin/nginx -v
   ```

2. **创建必要目录**
   ```bash
   sudo mkdir -p /opt/voice_community_be
   sudo mkdir -p /web
   sudo mkdir -p /web_backup
   sudo mkdir -p /opt/voice_community_be/logs
   sudo mkdir -p /opt/voice_community_be/temp
   ```

3. **配置权限**
   ```bash
   sudo chown -R $USER:$USER /opt/voice_community_be
   sudo chown -R nginx:nginx /web  # 或 www-data:www-data
   ```

### 后端部署

#### 方式一：使用部署脚本（推荐）
```bash
# 1. 将代码上传到服务器
# 2. 进入deploy目录
cd deploy

# 3. 赋予执行权限
chmod +x deploy-backend.sh

# 4. 执行部署（dev/test/prod）
./deploy-backend.sh dev
```

#### 方式二：手动部署
```bash
# 1. 进入后端项目目录
cd voice_community_backend

# 2. 构建项目
mvn clean package -DskipTests

# 3. 停止旧服务
/usr/local/java/jdk-21.0.3/bin/jps -l | grep voice_community_backend
kill -15 <PID>

# 4. 备份旧JAR（如果存在）
cp /opt/voice_community_be/voice_community_backend-0.0.1-SNAPSHOT.jar \
   /opt/voice_community_be/voice_community_backend-0.0.1-SNAPSHOT.jar.backup

# 5. 复制新JAR
cp target/voice_community_backend-0.0.1-SNAPSHOT.jar /opt/voice_community_be/

# 6. 启动服务
cd /opt/voice_community_be
nohup /usr/local/java/jdk-21.0.3/bin/java -jar \
    -Xms512m -Xmx1024m \
    voice_community_backend-0.0.1-SNAPSHOT.jar > logs/app.log 2>&1 &

# 7. 查看日志
tail -f logs/app.log
```

### 前端部署

#### 方式一：使用部署脚本（推荐）
```bash
# 1. 将代码上传到服务器
# 2. 进入deploy目录
cd deploy

# 3. 赋予执行权限
chmod +x deploy-frontend.sh

# 4. 执行部署
./deploy-frontend.sh dev
```

#### 方式二：手动部署
```bash
# 1. 进入前端项目目录
cd voice_community_fe

# 2. 安装依赖（如果node_modules不存在）
npm install

# 3. 构建项目
npm run build

# 4. 备份旧文件（如果存在）
sudo cp -r /web /web_backup/backup_$(date +%Y%m%d_%H%M%S)

# 5. 清理部署目录
sudo rm -rf /web/*

# 6. 复制新文件
sudo cp -r dist/* /web/

# 7. 设置权限
sudo chown -R nginx:nginx /web

# 8. 重载Nginx
sudo /usr/local/nginx/sbin/nginx -s reload
```

### Nginx配置

#### 1. 添加Nginx配置
将 `deploy/nginx.conf.example` 的内容添加到Nginx配置中：

```bash
# 方式一：添加到主配置文件
sudo vim /usr/local/nginx/conf/nginx.conf

# 方式二：创建独立配置文件（推荐）
sudo cp deploy/nginx.conf.example /usr/local/nginx/conf/conf.d/voice_community.conf
```

#### 2. 修改配置中的域名
编辑配置文件，将 `your-domain.com` 替换为实际域名或IP

#### 3. 测试并重载
```bash
# 测试配置
sudo /usr/local/nginx/sbin/nginx -t

# 重载配置
sudo /usr/local/nginx/sbin/nginx -s reload
```

---

## 配置说明

### 后端配置

#### application.yml
```yaml
spring:
  datasource:
    url: jdbc:dm://数据库地址:5236?schema=VCDB
    username: 数据库用户名
    password: 数据库密码
  servlet:
    multipart:
      max-file-size: 20MB  # 文件上传大小限制

server:
  port: 8081  # 服务端口

logging:
  level:
    root: INFO
  path: ./logs  # 日志目录
```

#### 环境变量配置（可选）
可以通过环境变量覆盖配置：
```bash
export SPRING_DATASOURCE_URL=jdbc:dm://...
export SPRING_DATASOURCE_USERNAME=...
export SPRING_DATASOURCE_PASSWORD=...
```

### 前端配置

#### API地址配置
开发环境：通过 `vite.config.ts` 中的 proxy 配置自动代理
生产环境：通过 Nginx 反向代理 `/api` 到后端

如需修改API地址，编辑 `src/api/api.ts`:
```typescript
const baseURL = '/api'  // 生产环境使用相对路径，由Nginx代理
// 或
const baseURL = 'http://your-backend-host:8081'  // 直接指定后端地址
```

---

## 常见问题

### 1. 后端启动失败

**问题**: 端口被占用
```bash
# 查找占用端口的进程
lsof -i :8081
# 或
netstat -tulpn | grep 8081

# 停止进程
kill -15 <PID>
```

**问题**: 数据库连接失败
- 检查数据库地址、用户名、密码是否正确
- 检查数据库服务是否运行
- 检查网络连接和防火墙

**问题**: 内存不足
```bash
# 调整JVM参数
java -jar -Xms256m -Xmx512m your-app.jar
```

### 2. 前端构建失败

**问题**: 依赖安装失败
```bash
# 清除缓存重新安装
rm -rf node_modules package-lock.json
npm cache clean --force
npm install
```

**问题**: TypeScript类型错误
```bash
# 构建时跳过类型检查（不推荐，但可临时解决）
npm run build -- --skipLibCheck
```

### 3. Nginx配置问题

**问题**: 502 Bad Gateway
- 检查后端服务是否运行
- 检查Nginx配置中的proxy_pass地址是否正确
- 查看Nginx错误日志: `/usr/local/nginx/logs/error.log`

**问题**: 静态资源404
- 检查root路径是否正确
- 检查文件权限
- 检查Nginx用户是否有读取权限

### 4. 数据库迁移问题

**问题**: Flyway迁移失败
```bash
# 检查数据库连接
# 查看迁移历史
mvn flyway:info

# 修复迁移（谨慎使用）
mvn flyway:repair
```

### 5. 日志查看

**后端日志**:
```bash
# 实时查看
tail -f /opt/voice_community_be/logs/app.log

# 查看错误日志
grep ERROR /opt/voice_community_be/logs/app.log
```

**Nginx日志**:
```bash
# 访问日志
tail -f /usr/local/nginx/logs/voice_community_access.log

# 错误日志
tail -f /usr/local/nginx/logs/voice_community_error.log
```

---

## 服务管理

### 后端服务管理

```bash
# 查看运行状态
/usr/local/java/jdk-21.0.3/bin/jps -l | grep voice_community_backend

# 停止服务
kill -15 <PID>

# 强制停止
kill -9 <PID>

# 启动服务
cd /opt/voice_community_be
nohup /usr/local/java/jdk-21.0.3/bin/java -jar voice_community_backend-0.0.1-SNAPSHOT.jar > logs/app.log 2>&1 &
```

### Nginx服务管理

```bash
# 启动
sudo /usr/local/nginx/sbin/nginx

# 停止
sudo /usr/local/nginx/sbin/nginx -s stop

# 重载配置
sudo /usr/local/nginx/sbin/nginx -s reload

# 测试配置
sudo /usr/local/nginx/sbin/nginx -t
```

---

## 部署检查清单

### 部署前
- [ ] 数据库已创建并配置正确
- [ ] 数据库迁移脚本已执行
- [ ] 配置文件已更新（数据库连接、API地址等）
- [ ] 服务器环境已准备（Java、Node.js、Nginx）

### 后端部署
- [ ] 代码已更新到最新版本
- [ ] Maven构建成功
- [ ] JAR文件已复制到部署目录
- [ ] 旧服务已停止
- [ ] 新服务已启动
- [ ] 日志无错误信息
- [ ] 健康检查通过（访问 `/voice/getVoicesByParam` 测试）

### 前端部署
- [ ] 代码已更新到最新版本
- [ ] npm构建成功
- [ ] dist目录文件已复制到/web
- [ ] 文件权限已设置
- [ ] Nginx配置已更新
- [ ] Nginx已重载
- [ ] 前端页面可正常访问
- [ ] API请求可正常代理

### 部署后
- [ ] 功能测试通过
- [ ] 性能测试通过
- [ ] 日志监控正常
- [ ] 备份已创建

---

## 联系支持

如遇到问题，请：
1. 查看日志文件
2. 检查配置文件
3. 参考本文档的常见问题部分
4. 联系开发团队





